name: AI SEO Optimization

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ai-seo-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm install openai cheerio fs-extra

      - name: AI SEO Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        run: |
          cat > ai-seo-analysis.js << 'EOF'
          const OpenAI = require('openai');
          const cheerio = require('cheerio');
          const fs = require('fs-extra');
          const path = require('path');

          async function performAISEOAnalysis() {
            try {
              console.log('ğŸ” å¼€å§‹AIé©±åŠ¨çš„SEOåˆ†æ...');

              // Initialize OpenAI client
              const openai = new OpenAI({
                apiKey: process.env.OPENAI_API_KEY,
                baseURL: process.env.OPENAI_BASE_URL || 'https://api.siliconflow.cn/v1'
              });

              // Read and parse the HTML file
              const htmlPath = 'website-deploy/index.html';
              if (!fs.existsSync(htmlPath)) {
                throw new Error('HTML file not found: ' + htmlPath);
              }

              const html = await fs.readFile(htmlPath, 'utf8');
              const $ = cheerio.load(html);

              // Extract page content for AI analysis
              const title = $('title').text();
              const description = $('meta[name="description"]').attr('content') || '';
              const keywords = $('meta[name="keywords"]').attr('content') || '';
              const h1Text = $('h1').first().text();
              const bodyText = $('body').text().replace(/\s+/g, ' ').trim();
              const mainContent = $('main, .container, #main, .content').first().text().replace(/\s+/g, ' ').trim();

              // Product context for analysis
              const productContext = {
                name: 'UE MOD Manager',
                description: 'ä¸“ä¸šçš„è™šå¹»å¼•æ“MODç®¡ç†å™¨ï¼Œæ”¯æŒå¤šæ¬¾çƒ­é—¨æ¸¸æˆ',
                games: ['å‰‘æ˜ŸStellar Blade', 'é»‘ç¥è¯æ‚Ÿç©º', 'æ˜æœ«æ— åŒ', 'å…¶ä»–è™šå¹»å¼•æ“æ¸¸æˆ'],
                features: ['ä¸€é”®MODå®‰è£…', 'è‡ªåŠ¨å†²çªæ£€æµ‹', 'äº‘ç«¯åŒæ­¥å¤‡ä»½', 'æ‰¹é‡ç®¡ç†', 'å…è´¹å¼€æº'],
                targetKeywords: ['MODç®¡ç†å™¨', 'è™šå¹»å¼•æ“', 'UE4', 'UE5', 'æ¸¸æˆMOD', 'MODå·¥å…·']
              };

              // Create AI prompt for SEO analysis
              const aiPrompt = "ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„SEOä¸“å®¶ï¼Œè¯·åˆ†æä»¥ä¸‹ç½‘é¡µçš„SEOçŠ¶å†µå¹¶æä¾›å…·ä½“çš„ä¼˜åŒ–å»ºè®®ã€‚\n\n" +
                "äº§å“ä¿¡æ¯ï¼š\n" +
                "- äº§å“åç§°ï¼š" + productContext.name + "\n" +
                "- äº§å“æè¿°ï¼š" + productContext.description + "\n" +
                "- æ”¯æŒæ¸¸æˆï¼š" + productContext.games.join(', ') + "\n" +
                "- æ ¸å¿ƒåŠŸèƒ½ï¼š" + productContext.features.join(', ') + "\n" +
                "- ç›®æ ‡å…³é”®è¯ï¼š" + productContext.targetKeywords.join(', ') + "\n\n" +
                "ç½‘é¡µå†…å®¹ï¼š\n" +
                "- æ ‡é¢˜ï¼š" + title + "\n" +
                "- æè¿°ï¼š" + description + "\n" +
                "- å…³é”®è¯ï¿½ï¿½ï¿½" + keywords + "\n" +
                "- ä¸»æ ‡é¢˜ï¼š" + h1Text + "\n" +
                "- ä¸»è¦å†…å®¹ï¼š" + mainContent.substring(0, 1000) + "...\n" +
                "- å…¨æ–‡å†…å®¹ï¼š" + bodyText.substring(0, 2000) + "...\n\n" +
                "è¯·æä¾›ä»¥ä¸‹åˆ†æï¼š\n\n" +
                "1. **SEOè¯„åˆ†** (1-100åˆ†)\n" +
                "2. **æ ‡é¢˜ä¼˜åŒ–å»ºè®®** (å¦‚æœéœ€è¦æ”¹è¿›ï¼Œæä¾›3ä¸ªæ›´å¥½çš„æ ‡é¢˜é€‰é¡¹)\n" +
                "3. **æè¿°ä¼˜åŒ–å»ºè®®** (å¦‚æœéœ€è¦æ”¹è¿›ï¼Œæä¾›2ä¸ªæ›´å¥½çš„æè¿°é€‰é¡¹)\n" +
                "4. **å…³é”®è¯åˆ†æ**ï¼š\n" +
                "   - å½“å‰å…³é”®è¯è¦†ç›–æƒ…å†µ\n" +
                "   - å»ºè®®æ·»åŠ çš„ç›¸å…³å…³é”®è¯ï¼ˆåŒ…æ‹¬é•¿å°¾å…³é”®è¯ï¼‰\n" +
                "   - å…³é”®è¯å¯†åº¦å»ºè®®\n" +
                "5. **å†…å®¹ä¼˜åŒ–å»ºè®®**ï¼š\n" +
                "   - H1æ ‡ç­¾ä¼˜åŒ–\n" +
                "   - å†…å®¹ç»“æ„æ”¹è¿›\n" +
                "   - å†…éƒ¨é“¾æ¥å»ºè®®\n" +
                "6. **ç«å“å…³é”®è¯å»ºè®®** (åŸºäºäº§å“ç‰¹æ€§æ¨èç›¸å…³æœç´¢è¯)\n" +
                "7. **å¤šè¯­è¨€SEOå»ºè®®** (é’ˆå¯¹ä¸­è‹±æ–‡åŒè¯­ä¼˜åŒ–)\n\n" +
                "è¯·ä»¥JSONæ ¼å¼å›å¤ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n" +
                "{\n" +
                "  \"seoScore\": æ•°å­—,\n" +
                "  \"titleAnalysis\": {\n" +
                "    \"current\": \"å½“å‰æ ‡é¢˜\",\n" +
                "    \"issues\": [\"é—®é¢˜åˆ—è¡¨\"],\n" +
                "    \"suggestions\": [\"å»ºè®®1\", \"å»ºè®®2\", \"å»ºè®®3\"]\n" +
                "  },\n" +
                "  \"descriptionAnalysis\": {\n" +
                "    \"current\": \"å½“å‰æè¿°\",\n" +
                "    \"issues\": [\"é—®é¢˜åˆ—è¡¨\"],\n" +
                "    \"suggestions\": [\"å»ºè®®1\", \"å»ºè®®2\"]\n" +
                "  },\n" +
                "  \"keywordAnalysis\": {\n" +
                "    \"coveredKeywords\": [\"å·²è¦†ç›–çš„å…³é”®è¯\"],\n" +
                "    \"missingKeywords\": [\"é—æ¼çš„å…³é”®è¯\"],\n" +
                "    \"longtailKeywords\": [\"é•¿å°¾å…³é”®è¯åˆ—è¡¨\"],\n" +
                "    \"densityFeedback\": \"å…³é”®è¯å¯†åº¦åé¦ˆ\"\n" +
                "  },\n" +
                "  \"contentOptimization\": {\n" +
                "    \"h1Feedback\": \"H1æ ‡ç­¾åé¦ˆ\",\n" +
                "    \"structureSuggestions\": [\"ç»“æ„å»ºè®®1\", \"ç»“æ„å»ºè®®2\"],\n" +
                "    \"internalLinks\": [\"å†…éƒ¨é“¾æ¥å»ºè®®1\", \"å†…éƒ¨é“¾æ¥å»ºè®®2\"]\n" +
                "  },\n" +
                "  \"competitiveKeywords\": [\"ç«å“å…³é”®è¯1\", \"ç«å“å…³é”®è¯2\"],\n" +
                "  \"multilingualSEO\": [\"å¤šè¯­è¨€å»ºè®®1\", \"å¤šè¯­è¨€å»ºè®®2\"],\n" +
                "  \"priorityActions\": [\"ä¼˜å…ˆè¡ŒåŠ¨1\", \"ä¼˜å…ˆè¡ŒåŠ¨2\", \"ä¼˜å…ˆè¡ŒåŠ¨3\"]\n" +
                "}";

              // Call AI API
              const completion = await openai.chat.completions.create({
                model: 'Qwen/Qwen2.5-32B-Instruct',
                messages: [
                  {
                    role: 'system',
                    content: 'ä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„SEOä¸“å®¶ï¼Œæ“…é•¿ä¸­æ–‡å’Œè‹±æ–‡SEOä¼˜åŒ–ï¼Œç‰¹åˆ«æ˜¯æ¸¸æˆè½¯ä»¶å’ŒæŠ€æœ¯äº§å“ã€‚è¯·æä¾›ä¸“ä¸šã€å®ç”¨çš„å»ºè®®ã€‚'
                  },
                  {
                    role: 'user',
                    content: aiPrompt
                  }
                ],
                max_tokens: 2000,
                temperature: 0.7
              });

              const aiResponse = completion.choices[0].message.content;
              let analysisResult;

              try {
                analysisResult = JSON.parse(aiResponse);
              } catch (e) {
                console.error('AIå“åº”è§£æå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ ¼å¼');
                analysisResult = {
                  seoScore: 75,
                  summary: aiResponse,
                  issues: ['AIå“åº”è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå“åº”']
                };
              }

              // Generate analysis report
              const report = generateReport(analysisResult, title, description);

              // Save reports
              await fs.ensureDir('seo-output');
              await fs.writeFile('seo-output/ai-seo-analysis.json', JSON.stringify(analysisResult, null, 2));
              await fs.writeFile('seo-output/ai-seo-report.md', report);

              console.log('âœ… AI SEOåˆ†æå®Œæˆï¼');
              console.log('ğŸ“„ æŠ¥å‘Šå·²ä¿å­˜åˆ° seo-output/ ç›®å½•');

              // Display key metrics
              console.log('\nğŸ“Š å…³é”®æŒ‡æ ‡ï¼š');
              console.log('SEOè¯„åˆ†:', analysisResult.seoScore || 'N/A');
              if (analysisResult.titleAnalysis) {
                console.log('æ ‡é¢˜é—®é¢˜:', analysisResult.titleAnalysis.issues.length);
              }
              if (analysisResult.keywordAnalysis) {
                console.log('é—æ¼å…³é”®è¯:', analysisResult.keywordAnalysis.missingKeywords.length);
              }

            } catch (error) {
              console.error('âŒ AI SEOåˆ†æå¤±è´¥:', error.message);
              process.exit(1);
            }
          }

          function generateReport(analysis, currentTitle, currentDescription) {
            const timestamp = new Date().toLocaleString();

            let report = '# ğŸ¤– AIé©±åŠ¨çš„SEOä¼˜åŒ–æŠ¥å‘Š\n\n';
            report += '## ğŸ“Š åˆ†ææ¦‚è§ˆ\n\n';
            report += '- **åˆ†ææ–‡ä»¶**: website-deploy/index.html\n';
            report += '- **åˆ†ææ—¶é—´**: ' + timestamp + '\n';
            report += '- **SEOè¯„åˆ†**: ' + (analysis.seoScore || 'N/A') + '/100\n\n';

            if (analysis.titleAnalysis) {
              report += '## ğŸ¯ æ ‡é¢˜ä¼˜åŒ–å»ºè®®\n\n';
              report += '**å½“å‰æ ‡é¢˜**: ' + analysis.titleAnalysis.current + '\n\n';
              if (analysis.titleAnalysis.issues.length > 0) {
                report += '**å‘ç°é—®é¢˜**:\n';
                analysis.titleAnalysis.issues.forEach(issue => {
                  report += '- ' + issue + '\n';
                });
                report += '\n**ä¼˜åŒ–å»ºè®®**:\n';
                analysis.titleAnalysis.suggestions.forEach(suggestion => {
                  report += '- ' + suggestion + '\n';
                });
                report += '\n';
              }
            }

            if (analysis.descriptionAnalysis) {
              report += '## ğŸ“ æè¿°ä¼˜åŒ–å»ºè®®\n\n';
              report += '**å½“å‰æè¿°**: ' + analysis.descriptionAnalysis.current + '\n\n';
              if (analysis.descriptionAnalysis.issues.length > 0) {
                report += '**å‘ç°é—®é¢˜**:\n';
                analysis.descriptionAnalysis.issues.forEach(issue => {
                  report += '- ' + issue + '\n';
                });
                report += '\n**ä¼˜åŒ–å»ºè®®**:\n';
                analysis.descriptionAnalysis.suggestions.forEach(suggestion => {
                  report += '- ' + suggestion + '\n';
                });
                report += '\n';
              }
            }

            if (analysis.keywordAnalysis) {
              report += '## ğŸ”‘ å…³é”®è¯åˆ†æ\n\n';
              report += '**å·²è¦†ç›–å…³é”®è¯**: ' + analysis.keywordAnalysis.coveredKeywords.join(', ') + '\n\n';
              report += '**å»ºè®®æ·»åŠ å…³é”®è¯**: ' + analysis.keywordAnalysis.missingKeywords.join(', ') + '\n\n';
              report += '**é•¿å°¾å…³é”®è¯å»ºè®®**: ' + analysis.keywordAnalysis.longtailKeywords.slice(0, 5).join(', ') + '\n\n';
              report += '**å…³é”®è¯å¯†åº¦åé¦ˆ**: ' + analysis.keywordAnalysis.densityFeedback + '\n\n';
            }

            if (analysis.contentOptimization) {
              report += '## ğŸ“„ å†…å®¹ä¼˜åŒ–å»ºè®®\n\n';
              report += '**H1æ ‡ç­¾åé¦ˆ**: ' + analysis.contentOptimization.h1Feedback + '\n\n';
              report += '**ç»“æ„æ”¹è¿›å»ºè®®**:\n';
              analysis.contentOptimization.structureSuggestions.forEach(suggestion => {
                report += '- ' + suggestion + '\n';
              });
              report += '\n**å†…éƒ¨é“¾æ¥å»ºè®®**:\n';
              analysis.contentOptimization.internalLinks.forEach(link => {
                report += '- ' + link + '\n';
              });
              report += '\n';
            }

            if (analysis.competitiveKeywords && analysis.competitiveKeywords.length > 0) {
              report += '## ğŸ† ç«å“å…³é”®è¯å»ºè®®\n\n';
              analysis.competitiveKeywords.forEach(keyword => {
                report += '- ' + keyword + '\n';
              });
              report += '\n';
            }

            if (analysis.multilingualSEO && analysis.multilingualSEO.length > 0) {
              report += '## ğŸŒ å¤šè¯­è¨€SEOå»ºè®®\n\n';
              analysis.multilingualSEO.forEach(suggestion => {
                report += '- ' + suggestion + '\n';
              });
              report += '\n';
            }

            if (analysis.priorityActions && analysis.priorityActions.length > 0) {
              report += '## ğŸš€ ä¼˜å…ˆè¡ŒåŠ¨è®¡åˆ’\n\n';
              analysis.priorityActions.forEach((action, index) => {
                report += (index + 1) + '. ' + action + '\n';
              });
              report += '\n';
            }

            report += '## ğŸ“ˆ é¢„æœŸæ•ˆæœ\n\n';
            report += 'å®æ–½ä¸Šè¿°å»ºè®®åï¼Œé¢„æœŸSEOè¯„åˆ†å°†æå‡è‡³85-90åˆ†\n';
            report += 'ä¸»è¦å…³é”®è¯æ’åå°†æ˜¾è‘—æ”¹å–„ï¼Œç½‘ç«™æµé‡å°†ç¨³æ­¥å¢é•¿\n\n';

            report += '---\n';
            report += '*æŠ¥å‘Šç”±AIè‡ªåŠ¨ç”Ÿæˆï¼Œå»ºè®®ç»“åˆå®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´*';

            return report;
          }

          // Run the analysis
          performAISEOAnalysis();
          EOF

          node ai-seo-analysis.js

      - name: Upload AI SEO reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-seo-analysis-results
          path: seo-output/
          retention-days: 30