# 分类功能修复验证文档

## 修复内容

**Git分支：** `fix-category-config-path`
**提交ID：** `138fae3`

### 修复的问题

1. ✅ 分类重命名失效
2. ✅ 分类软删除（隐藏）失效
3. ✅ 分类拖拽排序失效
4. ✅ 二次重启出现重复分类

### 根本原因

在执行分类操作时，`currentGameName` 为空，导致配置文件保存路径错误：
```
错误路径: C:\Users\pc\AppData\Roaming\UEModManager\_category_display.json
正确路径: C:\Users\pc\AppData\Roaming\UEModManager\剑星 (Stellar Blade)_category_display.json
```

### 修复方案

1. **GetCategoryDisplayConfigPath()** - 添加 currentGameName 空值检查，抛出异常
2. **SaveCategoryDisplayConfig()** - 添加 currentGameName 空值检查，提前返回
3. 删除错误的配置文件 `_category_display.json`

---

## 测试验证步骤

### 准备工作

1. **编译项目**
   ```bash
   cd D:\cursor\2.0backup\backup_v1.7.32
   git checkout fix-category-config-path
   dotnet build UEModManager.sln --configuration Debug
   ```

2. **清理旧配置**（可选，用于全新测试）
   ```bash
   # 备份现有配置
   copy "%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json" "%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json.bak"

   # 删除配置文件（全新测试）
   del "%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json"
   ```

---

### 测试1：分类重命名功能

**操作步骤：**

1. 启动程序，选择游戏"剑星 (Stellar Blade)"
2. 右键点击默认分类"面部"
3. 选择"重命名分类"
4. 输入新的显示名称："面部美化MOD"
5. 确认修改

**预期结果：**

- ✅ 左侧分类列表显示"面部"（实际名称不变）
- ✅ 右键MOD → 移动到分类 → 显示"面部（面部美化MOD）"
- ✅ 配置文件生成：`%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json`
- ✅ 配置文件内容包含：
  ```json
  {
    "面部": {
      "DisplayName": "面部美化MOD",
      "IsHidden": false,
      "IsCustom": false,
      "SortOrder": 1
    }
  }
  ```

**验证步骤：**

6. 关闭程序
7. 重新启动程序
8. 检查分类显示名称是否保持为"面部美化MOD"

**判定标准：**
- ✅ 通过：重启后显示名称保持不变
- ❌ 失败：重启后显示名称恢复为"面部"

---

### 测试2：分类软删除（隐藏）功能

**操作步骤：**

1. 启动程序，选择游戏"剑星 (Stellar Blade)"
2. 右键点击默认分类"人物"
3. 选择"删除分类"
4. 确认删除

**预期结果：**

- ✅ 分类"人物"从左侧列表中消失（软删除）
- ✅ 配置文件更新，添加：
  ```json
  {
    "人物": {
      "DisplayName": null,
      "IsHidden": true,
      "IsCustom": false,
      "SortOrder": 2
    }
  }
  ```

**验证步骤：**

5. 关闭程序
6. 重新启动程序
7. 检查分类"人物"是否仍然隐藏

**判定标准：**
- ✅ 通过：重启后"人物"分类不显示
- ❌ 失败：重启后"人物"分类又出现了

---

### 测试3：分类拖拽排序功能

**操作步骤：**

1. 启动程序，选择游戏"剑星 (Stellar Blade)"
2. 记录当前分类顺序（例如：面部、人物、武器、服装）
3. 拖动"武器"分类到"面部"上方
4. 观察控制台日志输出：
   ```
   [拖拽排序] 分类 '武器' 从位置 X 移动到 Y，并已保存排序配置
   ```

**预期结果：**

- ✅ 分类顺序立即改变（武器、面部、人物、服装）
- ✅ 配置文件更新所有分类的 SortOrder
- ✅ 控制台显示保存成功日志

**验证步骤：**

5. 关闭程序
6. 重新启动程序
7. 检查分类顺序是否保持拖拽后的顺序

**判定标准：**
- ✅ 通过：重启后分类顺序保持为（武器、面部、人物、服装）
- ❌ 失败：重启后分类顺序恢复为默认顺序

---

### 测试4：二次重启不出现重复分类

**操作步骤：**

1. 启动程序，选择游戏"剑星 (Stellar Blade)"
2. 记录当前分类数量（例如：9个）
3. 关闭程序
4. 再次启动程序
5. 检查分类数量

**预期结果：**

- ✅ 第一次启动分类数量：9个
- ✅ 第二次启动分类数量：9个（不变）
- ✅ 控制台不出现"分类显示刷新完成，共 10 个分类"的增加

**验证步骤：**

6. 多次重启程序（3-5次）
7. 每次启动检查分类数量

**判定标准：**
- ✅ 通过：每次启动分类数量保持一致
- ❌ 失败：每次启动分类数量递增

---

### 测试5：小手柄拖拽功能

**操作步骤：**

1. 启动程序，选择游戏"剑星 (Stellar Blade)"
2. 将鼠标悬停在分类项右侧的"⋮⋮"小手柄上
3. 观察鼠标光标是否变为四向箭头（SizeAll）
4. 观察小手柄颜色是否变为高亮（#00D4AA）
5. 按住左键拖动分类
6. 观察是否出现拖拽预览效果

**预期结果：**

- ✅ 鼠标悬停时光标变为 `⇔` 四向箭头
- ✅ 小手柄颜色从灰色 (#6B7280) 变为绿色 (#00D4AA)
- ✅ 拖动时显示半透明的拖拽预览
- ✅ 放下后分类顺序改变

**判定标准：**
- ✅ 通过：所有视觉反馈正常，拖拽顺畅
- ❌ 失败：小手柄无响应或拖拽失效

---

## 日志验证要点

### 启动时日志检查

**正确日志示例：**
```
[加载分类配置] 加载到 3 条显示配置
[DEBUG] 从游戏特定文件加载分类: 4 个分类
[DEBUG] 分类显示刷新完成，共 9 个分类  ← 数量一致，无重复
```

**错误日志示例（修复前）：**
```
[DEBUG] 从游戏特定文件加载分类: 4 个分类
[DEBUG] 分类显示刷新完成，共 10 个分类  ← 数量增加，说明重复初始化
```

### 保存时日志检查

**正确日志示例：**
```
[保存分类配置] 更新分类 '面部': DisplayName=面部美化MOD, IsHidden=false, IsCustom=false, SortOrder=1
[保存分类配置] 分类显示配置已保存到: C:\Users\pc\AppData\Roaming\UEModManager\剑星 (Stellar Blade)_category_display.json
[保存分类配置] 共保存 3 个分类配置（含已隐藏分类）
```

**错误日志示例（修复前）：**
```
[保存分类配置] currentGameName 为空，跳过保存  ← 说明currentGameName未正确设置
```

---

## 配置文件验证

### 文件位置

```
正确路径: C:\Users\pc\AppData\Roaming\UEModManager\剑星 (Stellar Blade)_category_display.json
错误路径: C:\Users\pc\AppData\Roaming\UEModManager\_category_display.json （应已删除）
```

### 配置文件格式

**完整示例：**
```json
{
  "面部": {
    "DisplayName": "面部美化MOD",
    "IsHidden": false,
    "IsCustom": false,
    "SortOrder": 1
  },
  "人物": {
    "DisplayName": null,
    "IsHidden": true,
    "IsCustom": false,
    "SortOrder": 2
  },
  "武器": {
    "DisplayName": null,
    "IsHidden": false,
    "IsCustom": false,
    "SortOrder": 0
  }
}
```

**字段说明：**
- `DisplayName` - 自定义显示名称（null表示使用默认名称）
- `IsHidden` - 是否隐藏（true=软删除）
- `IsCustom` - 是否为自定义分类（false=默认分类）
- `SortOrder` - 排序顺序（数字越小越靠前）

---

## 常见问题排查

### Q1: 重命名后重启恢复原名

**可能原因：**
- 配置文件路径错误（检查是否为 `_category_display.json`）
- currentGameName 为空（检查日志）

**排查步骤：**
1. 检查配置文件路径是否正确
2. 查看控制台日志是否有"currentGameName 为空"
3. 检查游戏是否正确选择

### Q2: 拖拽排序不生效

**可能原因：**
- 拖拽的是系统分类（全部、已启用、已禁用）
- 配置保存失败

**排查步骤：**
1. 确认拖拽的不是系统分类
2. 查看控制台是否有"[拖拽排序]"日志
3. 检查配置文件是否更新

### Q3: 删除后重启又出现

**可能原因：**
- 软删除配置未保存
- 配置文件路径错误

**排查步骤：**
1. 检查配置文件中对应分类的 `IsHidden` 是否为 `true`
2. 确认配置文件路径正确
3. 查看日志是否有保存成功信息

---

## 回退方案

如果修复后出现新问题，可以回退到主分支：

```bash
# 切换回主分支
git checkout main

# 恢复配置文件（如果有备份）
copy "%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json.bak" "%APPDATA%\UEModManager\剑星 (Stellar Blade)_category_display.json"
```

---

## 测试完成标准

**所有测试项全部通过** 才算修复成功：

- ✅ 测试1：分类重命名功能
- ✅ 测试2：分类软删除功能
- ✅ 测试3：分类拖拽排序功能
- ✅ 测试4：二次重启无重复分类
- ✅ 测试5：小手柄拖拽功能

---

**修复版本：** v1.7.38-fix
**测试日期：** 2025-10-06
**文档作者：** Claude (Sonnet 4.5)
